<!DOCTYPE html>
<html>
<head>
    <title>SK-AUTH | Admin</title>
    <style>
        body {
            background: transparent;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .panel {
            background: #151515;
            padding: 75px 30px 30px 30px;
            border-radius: 12px;
            width: 320px;
            text-align: center;
            position: relative;
            border: 1px solid #00ff88;
            color: white;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
            animation: glow-pulse 3s infinite ease-in-out;
            box-sizing: border-box;
        }

        .titlebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            -webkit-app-region: drag;
            z-index: 9999;
            /* pointer-events: none; */ /* allows clicks to pass through except buttons */
        }

        .window-controls {
            display: flex;
            -webkit-app-region: no-drag;
            padding-right: 5px;
            pointer-events: auto;
        }

        .control-btn {
            padding: 5px 12px;
            cursor: pointer;
            font-size: 12px;
            transition: 0.2s;
            color: #555;
        }

            .control-btn:hover {
                color: #00ff88;
            }

        .close-btn:hover {
            color: #ff3e3e;
        }

        @keyframes glow-pulse {
            0% {
                box-shadow: 0 0 10px rgba(0,255,136,0.2);
                border-color: #00ff88;
            }

            50% {
                box-shadow: 0 0 25px rgba(0,255,136,0.4);
                border-color: #00ffaa;
            }

            100% {
                box-shadow: 0 0 10px rgba(0,255,136,0.2);
                border-color: #00ff88;
            }
        }

        h2 {
            color: #00ff88;
            letter-spacing: 2px;
            margin: 10px 0 20px;
            font-size: 1.2rem;
            text-transform: uppercase;
        }

        input, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #222;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
            outline: none;
        }

            input:focus {
                border-color: #00ff88;
            }

        button {
            width: 100%;
            padding: 12px;
            background: #00ff88;
            border: none;
            color: black;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.3s;
            margin-top: 10px;
        }

            button:hover {
                background: #00cc6e;
                transform: translateY(-1px);
            }

        #key-display {
            margin-top: 20px;
            padding: 15px;
            background: #000;
            border: 1px dashed #00ff88;
            color: #00ff88;
            display: none;
        }

        .loader {
            border: 2px solid #000;
            border-top: 2px solid #000;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #manage-info {
            margin-top: 10px;
            background: #111;
            padding: 10px;
            border: 1px solid #222;
            text-align: left;
            font-size: 13px;
            display: none;
        }

            #manage-info button {
                margin: 3px 0;
                width: 48%;
                font-size: 12px;
            }

                #manage-info button + button {
                    margin-left: 4%;
                }
    </style>
</head>
<body>

    <div class="panel">
        <div class="titlebar">
            <div class="window-controls">
                <div class="control-btn" onclick="minWin()">—</div>
                <div class="control-btn close-btn" onclick="closeWin()">✕</div>
            </div>
        </div>

        <h2>SK ADMIN PANEL</h2>

        <input type="password" id="admin-pass" placeholder="Admin Password">

        <!-- CREATE KEY -->
        <div style="margin-top:10px;border-top:1px solid #222;padding-top:15px;">
            <div style="font-size:12px;color:#888;text-align:left;">CREATE KEY</div>

            <select id="key-days">
                <option value="1">1 Day</option>
                <option value="7">7 Days</option>
                <option value="30" selected>30 Days</option>
                <option value="999">Lifetime</option>
            </select>

            <select id="key-game">
                <option value="FiveM">FiveM</option>
                <option value="GTAV">GTAV</option>
                <option value="Warzone">Warzone</option>
                <option value="CS2">CS2</option>
            </select>

            <button id="gen-btn" onclick="generateKey()">GENERATE KEY</button>

            <div id="key-display">
                <div style="font-size:12px;color:#888;">KEY GENERATED</div>
                <div id="key-text" style="font-size:1.1em;font-weight:bold;margin:6px 0;"></div>

                <div style="text-align:left;font-size:13px;">
                    <div><span style="color:#888;">Duration:</span> <span id="key-days-display"></span></div>
                    <div><span style="color:#888;">Expires:</span> <span id="key-expiry"></span></div>
                    <div><span style="color:#888;">Games:</span> <span id="key-games"></span></div>
                </div>
            </div>
        </div>

        <!-- MANAGE KEY SECTION -->
        <div style="margin-top:20px;border-top:1px solid #222;padding-top:15px;">
            <div style="font-size:12px;color:#888;text-align:left;">MANAGE KEY</div>

            <!-- Dropdown -->
            <select id="manage-key-input">
                <option value="">-- Select License Key --</option>
            </select>

            <!-- Load All Keys Button -->
            <button onclick="loadKeysDropdown()" style="background:#444;color:white;">
                LOAD ALL KEYS
            </button>

            <!-- Load Selected Key Info -->
            <button id="load-btn" onclick="loadKey()">
                LOAD KEY
            </button>

            <div id="manage-info">
                <div style="margin-top:10px; border-bottom:1px solid #222; padding-bottom:10px; margin-bottom:10px;">
                    <div><span style="color:#888;">Status:</span> <span id="manage-status"></span></div>
                    <div>
                        <span style="color:#888;">HWID:</span>
                        <span id="manage-hwid" style="font-size:10px; word-break:break-all;"></span>
                    </div>
                    <div><span style="color:#888;">Expiry:</span> <span id="manage-expiry"></span></div>
                    <div><span style="color:#888;">Games:</span> <span id="manage-games"></span></div>
                </div>

                <div style="margin-top:10px;">
                    <div style="display:flex; gap:5px;">
                        <button onclick="pauseKey()" style="flex:1;">PAUSE</button>
                        <button onclick="unpauseKey()" style="flex:1;">UNPAUSE</button>
                    </div>

                    <button style="background:#00f2ff;color:black;width:100%;margin:5px 0;"
                            onclick="resetHWID()">
                        RESET HWID
                    </button>

                    <div style="display:flex; gap:5px;">
                        <button style="background:#ff3e3e;color:white;flex:1;"
                                onclick="banKey()">
                            BAN
                        </button>
                        <button style="background:#444;color:white;flex:1;"
                                onclick="deleteKey()">
                            DELETE
                        </button>
                    </div>
                </div>
            </div>
        </div>



        <script>
            const { ipcRenderer, clipboard } = require('electron');
            const API = 'https://sk-auth-api.up.railway.app';

            function closeWin() { ipcRenderer.send('admin-close'); }
            function minWin() { ipcRenderer.send('admin-min'); }

            // GENERATE KEY
            async function generateKey() {
                const btn = document.getElementById('gen-btn');
                const pass = document.getElementById('admin-pass').value;
                const days = document.getElementById('key-days').value;
                const game = document.getElementById('key-game').value;
                const display = document.getElementById('key-display');
                const keyText = document.getElementById('key-text');

                if (!pass) return alert("Enter Admin Password!");

                btn.disabled = true;
                btn.innerHTML = '<div class="loader"></div>';
                display.style.display = 'none';

                try {
                    const response = await fetch(`${API}/admin/create-key`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            admin_password: pass,
                            days: parseInt(days),
                            games: [game]
                        })
                    });

                    if (!response.ok && response.status !== 401) throw new Error(`Server returned ${response.status}`);

                    const data = await response.json();

                    if (data.success) {
                        display.style.display = 'block';
                        keyText.innerText = `${game.substring(0, 2).toUpperCase()}-${data.key}`;
                        document.getElementById('key-days-display').innerText = days == 999 ? "Lifetime" : days + " Day(s)";
                        document.getElementById('key-expiry').innerText = new Date(data.expires).toLocaleString();
                        document.getElementById('key-games').innerText = data.games.join(", ");
                        if (clipboard) clipboard.writeText(data.key);
                    } else {
                        alert("API Error: " + (data.error || "Access Denied"));
                    }
                } catch (err) {
                    console.error(err);
                    alert("Failed to connect to server.");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'GENERATE KEY';
                }
            }

            // LOAD KEY (Matched to your Backend Response)
            async function loadKey() {
                const key = document.getElementById('manage-key-input').value;
                const pass = document.getElementById('admin-pass').value;
                const infoDiv = document.getElementById('manage-info');

                if (!key || !pass) return alert("Enter Key and Admin Password!");

                try {
                    // REMOVED '/api' because your backend route is just '/admin/get-key'
                    const res = await fetch(`${API}/admin/get-key`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ license_key: key, admin_password: pass })
                    });

                    const data = await res.json();

                    if (data.success) {
                        infoDiv.style.display = 'block';

                        // Matches your backend: user.is_banned, user.is_paused, etc.
                        document.getElementById('manage-status').innerText = data.is_banned ? "BANNED" : (data.is_paused ? "PAUSED" : "ACTIVE");

                        // Matches your backend: user.hwid
                        document.getElementById('manage-hwid').innerText = (data.hwid === "null" || !data.hwid) ? "READY FOR CAPTURE" : data.hwid;

                        // Matches your backend: user.expiry_date (sent as 'expiry' in your JSON)
                        document.getElementById('manage-expiry').innerText = data.expiry ? new Date(data.expiry).toLocaleString() : "N/A";

                        // Matches your backend: user.games
                        document.getElementById('manage-games').innerText = data.games ? data.games.join(", ") : "None";

                    } else {
                        alert(data.error || "Failed to load key");
                    }
                } catch (err) {
                    console.error(err);
                    // This is where you were hitting "Connection Failed"
                    alert("Connection failed: Check if Railway server is awake and URL is correct.");
                }
            }

            async function resetHWID() {
                const key = document.getElementById('manage-key-input').value;
                const pass = document.getElementById('admin-pass').value;

                if (!confirm(`Are you sure you want to reset HWID for ${key}?`)) return;

                try {
                    // REMOVED '/api' TO MATCH YOUR OTHER ROUTES
                    const response = await fetch(`${API}/admin/reset-hwid`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            admin_password: pass,
                            license_key: key
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert("HWID Reset Successful!");
                        loadKey(); // Refresh the info display automatically
                    } else {
                        alert("Reset Failed: " + (data.error || data.message || "Unknown Error"));
                    }
                } catch (err) {
                    alert("Error connecting to API. Check console for details.");
                    console.error(err);
                }
            }

            // KEY ACTIONS
            async function pauseKey() { await modifyKey('pause'); }
            async function unpauseKey() { await modifyKey('unpause'); }
            async function banKey() { await modifyKey('ban'); }
            async function deleteKey() { await modifyKey('delete'); }

            async function modifyKey(action) {
                const key = document.getElementById('manage-key-input').value;
                const pass = document.getElementById('admin-pass').value;

                if (!key || !pass) return alert("Enter Key and Admin Password!");

                try {
                    const res = await fetch(`${API}/admin/${action}-key`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ license_key: key, admin_password: pass })
                    });
                    const data = await res.json();

                    if (data.success) {
                        alert(`Key ${action.toUpperCase()} successful`);
                        loadKey(); // refresh info
                    } else {
                        alert(data.error || `Failed to ${action} key`);
                    }
                } catch (err) {
                    console.error(err);
                    alert("Connection failed");
                }
            }

            // LOAD ALL KEYS INTO DROPDOWN
            async function loadKeysDropdown() {
                const pass = document.getElementById('admin-pass').value;
                const dropdown = document.getElementById('manage-key-input');

                if (!pass) return alert("Enter Admin Password!");

                dropdown.innerHTML = '<option value="">Loading keys...</option>';

                try {
                    const res = await fetch(`${API}/admin/load-keys`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json', // force JSON
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ admin_password: pass })
                    });

                    console.log("Fetch status:", res.status);

                    // First check response content-type
                    const contentType = res.headers.get('content-type');
                    console.log("Content-Type:", contentType);

                    let data;
                    try {
                        data = await res.json(); // use .json() directly
                    } catch (jsonErr) {
                        const text = await res.text(); // fallback raw text
                        console.error("Failed to parse JSON, raw response:", text);
                        alert("Server returned invalid JSON. Check console.");
                        dropdown.innerHTML = '<option value="">-- Select License Key --</option>';
                        return;
                    }

                    if (data.success && Array.isArray(data.keys)) {
                        dropdown.innerHTML = '<option value="">-- Select License Key --</option>';
                        data.keys.forEach(k => {
                            const option = document.createElement("option");
                            option.value = k.license_key;
                            option.textContent = k.license_key;
                            dropdown.appendChild(option);
                        });
                    } else {
                        dropdown.innerHTML = '<option value="">-- Select License Key --</option>';
                        alert(data.error || "Failed to load keys");
                    }

                } catch (err) {
                    console.error("Fetch error:", err);
                    alert("Connection failed. Make sure your API is reachable and not asleep.");
                    dropdown.innerHTML = '<option value="">-- Select License Key --</option>';
                }
            }
        </script>
</body>
</html>
