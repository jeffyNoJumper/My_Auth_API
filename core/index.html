require('dotenv').config();
const express = require('express');
const mongoose = require('mongoose');
const User = require('./User');
const jwt = require('jsonwebtoken');

const app = express();
app.use(express.json());

mongoose.connect(process.env.MONGO_URL);

app.post('/login', async (req, res) => {
  const { license_key, hwid } = req.body;
  const user = await User.findOne({ license_key });

  if (!user) return res.status(404).json({ error: "Invalid Key" });
  if (user.is_banned) return res.status(403).json({ error: "Banned" });
  if (new Date() > user.expiry_date) return res.status(403).json({ error: "Expired" });

  // HWID Lock Logic
  if (!user.hwid) {
    user.hwid = hwid; // Lock to first PC used
    await user.save();
  } else if (user.hwid !== hwid) {
    return res.status(403).json({ error: "HWID Mismatch" });
  }

  // Success: Return user info + JWT token
  const token = jwt.sign({ id: user._id }, process.env.JWT_SECRET, { expiresIn: '1h' });
  res.json({
    token,
    expiry: user.expiry_date,
    profile_pic: user.profile_pic,
    games: user.games
  });
});

app.listen(process.env.PORT || 3000);
